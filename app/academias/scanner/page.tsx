'use client';import { Html5QrcodeScanner } from 'html5-qrcode';import { useEffect,useRef,useState } from 'react';
export default function Scanner(){const readerRef=useRef<HTMLDivElement>(null);const [unitId,setUnitId]=useState('');const [msg,setMsg]=useState('Aponte a câmera para o QR.');
useEffect(()=>{const unit=new URLSearchParams(location.search).get('unit');if(unit)setUnitId(unit);if(!readerRef.current)return;const scanner=new Html5QrcodeScanner(readerRef.current.id,{fps:10,qrbox:250},false);const onSuccess=async(text:string)=>{if(!unitId){setMsg('Informe o Unit ID.');return;}setMsg('Validando...');const r=await fetch('/api/checkins/validate',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({token:text,unit_id:unitId})});const j=await r.json();if(r.ok&&j.ok)setMsg(`✅ Check-in OK — ${new Date(j.at).toLocaleString()}`);else{let reason=j.error||'inválido';if(reason==='cooldown_active')reason='Cooldown ativo — aguarde';if(reason==='monthly_limit_reached')reason='Limite mensal atingido';if(reason==='subscription_inactive')reason='Assinatura inativa';setMsg('❌ '+reason);}};scanner.render(onSuccess,()=>{});return()=>{try{scanner.clear();}catch{}};},[unitId]);
return(<div className="grid gap-3"><h1 className="text-2xl font-semibold">Scanner de Check-in</h1><input value={unitId} onChange={e=>setUnitId(e.target.value)} placeholder="Unit ID" className="border rounded px-3 py-2 w-80"/><div id="reader" ref={readerRef} style={{maxWidth:520}}/><div className="text-sm">{msg}</div></div>);}